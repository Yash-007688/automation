{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="admin-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1
                style="font-size: 2.2rem; font-weight: 800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                User Management</h1>
            <p style="color: var(--text-secondary);">Manage all registered accounts</p>
        </div>
        <a href="/admin" class="btn btn-secondary" style="text-decoration: none;">‚Üê Back to Dashboard</a>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--glass-border);">
                    <th
                        style="padding: 1.25rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase;">
                        User</th>
                    <th
                        style="padding: 1.25rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase;">
                        Plan / Tokens</th>
                    <th
                        style="padding: 1.25rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase;">
                        Instagram Auth</th>
                    <th
                        style="padding: 1.25rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase;">
                        Status</th>
                    <th
                        style="padding: 1.25rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in users %}
                {% set u = row.user %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.01)'"
                    onmouseout="this.style.background='transparent'">
                    <td style="padding: 1.25rem 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div
                                style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-purple); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.75rem; color: #fff;">
                                {{ u.avatar or u.username[0]|upper }}
                            </div>
                            <div>
                                <p style="font-weight: 700; margin: 0; color: #fff;">@{{ u.username }}</p>
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0;">{{ u.full_name
                                    }}</p>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1.25rem 1.5rem;">
                        <!-- Styled Plan Badges -->
                        {% if u.plan == 'Free' %}
                        <span
                            style="font-size: 0.75rem; background: rgba(148, 163, 184, 0.1); color: #94a3b8; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 700; border: 1px solid rgba(148, 163, 184, 0.2);">FREE</span>
                        {% elif u.plan == 'Starter' %}
                        <span
                            style="font-size: 0.75rem; background: rgba(6, 182, 212, 0.1); color: #06b6d4; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 700; border: 1px solid rgba(6, 182, 212, 0.2);">STARTER</span>
                        {% elif u.plan == 'Growth' %}
                        <span
                            style="font-size: 0.75rem; background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 700; border: 1px solid rgba(139, 92, 246, 0.2);">GROWTH</span>
                        {% elif u.plan == 'Pro' %}
                        <span
                            style="font-size: 0.75rem; background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 700; border: 1px solid rgba(245, 158, 11, 0.2);">PRO</span>
                        {% else %}
                        <span
                            style="font-size: 0.75rem; background: rgba(255, 255, 255, 0.05); color: #fff; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 700;">{{
                            u.plan|upper }}</span>
                        {% endif %}

                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.5rem 0;">{{ u.free_tokens
                            + u.paid_tokens }} Total Tokens</p>
                    </td>
                    <td style="padding: 1.25rem 1.5rem;">
                        {% if u.ig_username %}
                        <p style="font-size: 0.8rem; color: #fff; font-weight: 600; margin: 0;">{{ u.ig_username }}</p>
                        <p style="font-size: 0.7rem; color: var(--text-secondary); margin: 0.25rem 0;">Pass: <span
                                style="font-family: monospace; color: #fca5a5;">{{ row.decrypted_password }}</span></p>
                        {% else %}
                        <span style="font-size: 0.7rem; color: var(--text-secondary); font-style: italic;">Not
                            Connected</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1.25rem 1.5rem;">
                        {% if u.is_admin %}
                        <span
                            style="font-size: 0.75rem; color: #fca5a5; background: rgba(239, 68, 68, 0.1); padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 800; border: 1px solid rgba(239, 68, 68, 0.2);">ADMIN</span>
                        {% else %}
                        <span
                            style="font-size: 0.75rem; color: #94a3b8; background: rgba(255, 255, 255, 0.05); padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 600;">USER</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1.25rem 1.5rem; text-align: right;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn" onclick="grantTokens({{ u.id }}, '@{{ u.username }}')"
                                style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 4px; font-weight: 700; cursor: pointer;">
                                Grant Tokens
                            </button>
                            <form action="/admin/users/{{ u.id }}/delete" method="POST" style="display: inline;"
                                onsubmit="return confirm('Delete user @{{ u.username }}? This action cannot be undone.')">
                                <button class="btn"
                                    style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function grantTokens(userId, username) {
        const amount = prompt(`How many tokens would you like to grant to ${username}?`, "5000");
        if (amount !== null && !isNaN(amount) && amount > 0) {
            const formData = new FormData();
            formData.append('amount', amount);

            fetch(`/admin/users/${userId}/grant-tokens`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Successfully granted ${parseInt(amount).toLocaleString()} tokens!`);
                        window.location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(err => alert('An error occurred. Please try again.'));
        }
    }
</script>
{% endblock %}